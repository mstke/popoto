// Copyright (c) 2018 NHOGS Interactive.
(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jquery"),require("d3")):"function"==typeof define&&define.amd?define(["exports","jquery","d3"],t):t(e.popoto=e.popoto||{},e.jQuery,e.d3)})(this,function(e,o,i){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var t="2.0.3",m={idGen:0,generateId:function(){return m.idGen++},nodes:[],links:[],getRootNode:function(){return m.nodes[0]}},p={};p.LogLevels=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}),p.LEVEL=p.LogLevels.NONE,p.TRACE=!1,p.log=function(e,t){if(console&&e>=p.LEVEL)switch(p.TRACE&&(t=t+"\n"+(new Error).stack),e){case p.LogLevels.DEBUG:case p.LogLevels.INFO:console.log(t);break;case p.LogLevels.WARN:console.warn(t);break;case p.LogLevels.ERROR:console.error(t)}},p.debug=function(e){p.log(p.LogLevels.DEBUG,e)},p.info=function(e){p.log(p.LogLevels.INFO,e)},p.warn=function(e){p.log(p.LogLevels.WARN,e)};var v={MAX_RESULTS_COUNT:100,VALUE_QUERY_LIMIT:100,USE_PARENT_RELATION:!(p.error=function(e){p.log(p.LogLevels.ERROR,e)}),USE_RELATION_DIRECTION:!0,COLLECT_RELATIONS_WITH_VALUES:!1,prefilter:""};v.NEO4J_INTERNAL_ID=Object.freeze({queryInternalName:"NEO4JID"}),v.filterRelation=function(e){return!0},v.generateTaxonomyCountQuery=function(e){var t=R.node.getConstraintAttribute(e),n=[];return R.node.getPredefinedConstraints(e).forEach(function(e){n.push(e.replace(new RegExp("\\$identifier","g"),"n"))}),t===v.NEO4J_INTERNAL_ID?"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT ID(n)) as count":"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT n."+t+") as count"},v.generateQueryElements=function(t,s,e,u){var d=[],p=[],c=[],g=[],f={};if(R.node.getPredefinedConstraints(t.label).forEach(function(e){p.push(e.replace(new RegExp("\\$identifier","g"),t.internalLabel))}),d.push("("+t.internalLabel+":`"+t.label+"`)"),u||t.immutable){var n=v.generateNodeValueConstraints(t);for(var r in p=p.concat(n.whereElements),n.parameters)n.parameters.hasOwnProperty(r)&&(f[r]=n.parameters[r])}var h=0;return e.forEach(function(r){var a=r.source,o=r.target,l="->";v.USE_RELATION_DIRECTION&&!0!==o.isParentRelReverse||(l="-");var e="r"+h++;if(c.push(e),R.node.getPredefinedConstraints(o.label).forEach(function(e){p.push(e.replace(new RegExp("\\$identifier","g"),o.internalLabel))}),o!==s&&!0===o.isNegative)if(void 0!==o.value&&0<o.value.length){var i=0;o.value.forEach(function(e){var t,n=R.node.getConstraintAttribute(e.label);0===i?(t=o.internalLabel+"_"+n,i++):t=o.internalLabel+"_"+n+i++,p.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`{"+n+":$"+t+"}) )")})}else p.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`) )");else v.COLLECT_RELATIONS_WITH_VALUES&&o===s&&g.push("COLLECT("+e+") AS incomingRels"),d.push("("+a.internalLabel+":`"+a.label+"`)-["+e+":`"+r.label+"`]"+l+"("+o.internalLabel+":`"+o.label+"`)");if(o!==s&&(u||o.immutable)){var t=v.generateNodeValueConstraints(o);for(var n in p=p.concat(t.whereElements),t.parameters)t.parameters.hasOwnProperty(n)&&(f[n]=t.parameters[n])}}),{matchElements:d,whereElements:p,relationElements:c,returnElements:g,parameters:f}},v.generateNodeValueConstraints=function(e){var n={},t=[];if(void 0!==e.value&&0<e.value.length){var r=R.node.getConstraintAttribute(e.label),a=e.internalLabel+"_"+r;if(1<e.value.length)if(void 0!==e.isNegative&&e.isNegative){var o=0;e.value.forEach(function(e){var t;t=r===v.NEO4J_INTERNAL_ID?e.internalID:e.attributes[r],0===o?(n[a]=t,o++):n[a+o++]=t})}else n[a]=[],e.value.forEach(function(e){var t;t=r===v.NEO4J_INTERNAL_ID?e.internalID:e.attributes[r],n[a].push(t)}),r===v.NEO4J_INTERNAL_ID?t.push("ID("+e.internalLabel+") IN {`"+a+"`}"):t.push(e.internalLabel+"."+r+" IN {`"+a+"`}");else if(r===v.NEO4J_INTERNAL_ID?n[a]=e.value[0].internalID:n[a]=e.value[0].attributes[r],void 0===e.isNegative||!e.isNegative){r===v.NEO4J_INTERNAL_ID?t.push("ID("+e.internalLabel+") = {`"+a+"`}"):t.push(e.internalLabel+"."+r+" = {`"+a+"`}")}}return{parameters:n,whereElements:t}},v.getRelevantLinks=function(a,t,e){var o=e.slice(),n=[],l=[];return o.forEach(function(e){(void 0!==e.target.value&&0<e.target.value.length||e.target===t||e.target.isNegative)&&n.push(e)}),n.forEach(function(e){o.splice(o.indexOf(e),1)}),n.forEach(function(e){for(var t=e.source,n=!0;n;){var r=null;o.forEach(function(e){e.target===t&&(r=e)}),null===r?n=!1:r.source===a?(l.push(r),o.splice(o.indexOf(r),1),n=!1):(l.push(r),o.splice(o.indexOf(r),1),t=r.source)}}),n.concat(l)},v.getLinksToRoot=function(e,t){for(var n=[],r=e;r!==m.getRootNode();){for(var a,o=0;o<t.length;o++){var l=t[o];if(l.target===r){a=l;break}}a&&(n.push(a),r=a.source)}return n},v.generateResultQuery=function(e){var t=m.getRootNode(),n=v.generateQueryElements(t,t,v.getRelevantLinks(t,t,m.links),!0),r=n.matchElements,a=n.whereElements,o=n.relationElements,l=[],i=[],s=n.parameters,u=R.node.getResultOrderByAttribute(t.label);if(u){var d=R.node.isResultOrderAscending(t.label)?"ASC":"DESC";i.push("ORDER BY "+u+" "+d)}i.push("LIMIT "+v.MAX_RESULTS_COUNT);var p=R.node.getReturnAttributes(t.label);if(e)l.push(t.internalLabel),o.forEach(function(e){l.push(e)});else for(var c=0;c<p.length;c++){var g=p[c];g===v.NEO4J_INTERNAL_ID?l.push("ID("+t.internalLabel+") AS "+v.NEO4J_INTERNAL_ID.queryInternalName):l.push(t.internalLabel+"."+g+" AS "+g)}var f="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN DISTINCT "+l.join(", ")+" "+i.join(" "),h=R.node.filterResultQuery(t.label,{statement:f,matchElements:r,whereElements:a,withElements:[],returnElements:l,endElements:i,parameters:s});return h.statement=v.prefilter+h.statement,h},v.generateNodeCountQuery=function(e){var t=v.generateQueryElements(m.getRootNode(),e,v.getRelevantLinks(m.getRootNode(),e,m.links),!0),n=t.matchElements,r=t.whereElements,a=[],o=t.parameters,l=R.node.getConstraintAttribute(e.label);l===v.NEO4J_INTERNAL_ID?a.push("count(DISTINCT ID("+e.internalLabel+")) as count"):a.push("count(DISTINCT "+e.internalLabel+"."+l+") as count");var i="MATCH "+n.join(", ")+(0<r.length?" WHERE "+r.join(" AND "):"")+" RETURN "+a.join(", "),s=R.node.filterNodeCountQuery(e,{statement:i,matchElements:n,whereElements:r,returnElements:a,endElements:[],parameters:o});return{statement:v.prefilter+s.statement,parameters:s.parameters}},v.generateNodeValueQuery=function(e){var t=m.getRootNode(),n=v.generateQueryElements(t,e,v.getRelevantLinks(t,e,m.links),!0),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=R.node.getValueOrderByAttribute(e.label);if(s){var u=R.node.isValueOrderAscending(e.label)?"ASC":"DESC";l.push("ORDER BY "+s+" "+u)}l.push("LIMIT "+v.VALUE_QUERY_LIMIT);for(var d=R.node.getReturnAttributes(e.label),p=(R.node.getConstraintAttribute(e.label),0);p<d.length;p++)d[p]===v.NEO4J_INTERNAL_ID?o.push("ID("+e.internalLabel+") AS "+v.NEO4J_INTERNAL_ID.queryInternalName):o.push(e.internalLabel+"."+d[p]+" AS "+d[p]);var c=R.node.getConstraintAttribute(t.label);c===v.NEO4J_INTERNAL_ID?o.push("count(DISTINCT ID("+t.internalLabel+")) AS count"):o.push("count(DISTINCT "+t.internalLabel+"."+c+") AS count"),v.COLLECT_RELATIONS_WITH_VALUES&&n.returnElements.forEach(function(e){o.push(e)});var g="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),f=R.node.filterNodeValueQuery(e,{statement:g,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:v.prefilter+f.statement,parameters:f.parameters}};var c={CYPHER_URL:"http://localhost:7474/db/data/transaction/commit",WITH_CREDENTIALS:!(v.generateNodeRelationQuery=function(e){var t=v.getLinksToRoot(e,m.links),n=v.generateQueryElements(m.getRootNode(),e,t,!1),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=v.USE_RELATION_DIRECTION?"->":"-";r.push("("+e.internalLabel+":`"+e.label+"`)-[r]"+s+"(x)"),o.push("type(r) AS label"),v.USE_PARENT_RELATION?o.push("head(labels(x)) AS target"):o.push("last(labels(x)) AS target"),o.push("count(r) AS count"),l.push("ORDER BY count(r) DESC");var u="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),d=R.node.filterNodeRelationQuery(e,{statement:u,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:v.prefilter+d.statement,parameters:d.parameters}}),post:function(e,t){var n=JSON.stringify(e);p.info("REST POST:"+n);var r={type:"POST",beforeSend:function(e){c.AUTHORIZATION&&e.setRequestHeader("Authorization",c.AUTHORIZATION)},contentType:"application/json"};void 0!==e&&(r.data=n),!0===c.WITH_CREDENTIALS&&(r.xhrFields={withCredentials:!0});var a=c.CYPHER_URL;return void 0!==t&&(a=t),o.ajax(a,r)}};c.response={parse:function(e){p.debug(JSON.stringify(e));var t=[];return void 0!==e&&e.hasOwnProperty("results")&&0<e.results.length&&!(e.hasOwnProperty("errors")&&0<e.errors.length)&&(t=e.results.map(function(e){for(var t=[],n=0;n<e.data.length;n++){for(var r={},a=0;a<e.columns.length;a++)r[e.columns[a]]=e.data[n].row[a];t.push(r)}return t})),p.info(JSON.stringify(t)),t}};var g={};function f(){d();var e=m.getRootNode();e&&void 0!==e.label&&(N.isActive&&N.updateQuery(),T.isActive&&T.updateQuery(),(g.isActive||0<g.resultListeners.length||0<g.resultCountListeners.length||0<g.graphResultListeners.length)&&g.updateResults())}function d(){A.isActive&&(A.link.updateLinks(),A.node.updateNodes(),A.force.nodes(m.nodes),A.force.force("link").links(m.links),A.force.alpha(1).restart())}g.containerId="popoto-results",g.hasChanged=!0,g.resultCountListeners=[],g.resultListeners=[],g.graphResultListeners=[],g.RESULTS_PAGE_SIZE=10,g.onTotalResultCount=function(e){g.resultCountListeners.push(e)},g.onResultReceived=function(e){g.resultListeners.push(e)},g.onGraphResultReceived=function(e){g.graphResultListeners.push(e)},g.parseGraphResultData=function(e){var t={},n={};e.results[0].data.forEach(function(e){e.graph.nodes.forEach(function(e){t.hasOwnProperty(e.id)||(t[e.id]=e)}),e.graph.relationships.forEach(function(e){n.hasOwnProperty(e.id)||(n[e.id]=e)})});var r=[],a=[];for(var o in t)t.hasOwnProperty(o)&&r.push(t[o]);for(var l in n)n.hasOwnProperty(l)&&a.push(n[l]);return{nodes:r,edges:a}},g.updateResults=function(){if(g.hasChanged){void 0!==g.resultsXhr&&g.resultsXhr.abort();var e=v.generateResultQuery(),t={statements:[{statement:(g.lastGeneratedQuery=e).statement,parameters:e.parameters,resultDataContents:["row"]}]};if(0<g.graphResultListeners.length){var n=v.generateResultQuery(!0);g.lastGeneratedQuery=n,t.statements.push({statement:n.statement,parameters:n.parameters,resultDataContents:["graph"]})}p.info("Results ==>"),g.resultsXhr=c.post(t).done(function(e){p.info("<== Results");var t=c.response.parse(e)[0].map(function(e,t){return{resultIndex:t,label:m.getRootNode().label,attributes:e}});if(g.lastResults=t,g.resultListeners.forEach(function(e){e(t)}),0<g.graphResultListeners.length){var n=g.parseGraphResultData(e);g.graphResultListeners.forEach(function(e){e(n)})}if(g.isActive){var r=i.select("#"+g.containerId).selectAll(".ppt-result").data([]);r.exit().remove(),(r=i.select("#"+g.containerId).selectAll(".ppt-result").data(t.slice(0,g.RESULTS_PAGE_SIZE),function(e){return e.resultIndex})).enter().append("div").attr("class","ppt-result").attr("id",function(e){return"popoto-result-"+e.resultIndex}).each(function(e){R.node.getDisplayResults(e.label)(i.select(this))})}g.hasChanged=!1}).fail(function(e,t,n){"abort"!==t?(p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),g.resultListeners.forEach(function(e){e([])})):p.info("<=X= Results - Aborted!")})}},g.updateResultsCount=function(){0<g.resultCountListeners.length&&g.resultCountListeners.forEach(function(e){e(m.getRootNode().count)})},g.generatePreQuery=function(){var t={ids:[]};return g.lastResults.forEach(function(e){t.ids.push(e.attributes.id)}),{query:"MATCH (d) WHERE d.id IN $ids WITH d",param:t}};var s={containerId:"popoto-taxonomy",createTaxonomyPanel:function(){var e=i.select("#"+s.containerId).append("ul").attr("class","ppt-taxo-ul"),t=s.generateTaxonomiesData(),n=e.selectAll(".taxo").data(t).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-li").attr("value",function(e){return e.label});n.append("span").attr("class",function(e){return"ppt-icon "+R.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),n.append("span").attr("class","ppt-label").text(function(e){return R.taxonomy.getTextValue(e.label)}),n.append("span").attr("class","ppt-count"),n.on("click",s.onClick),s.addTaxonomyChildren(n);var r=[];t.forEach(function(e){r.push(e),e.children&&s.flattenChildren(e,r)}),A.DISABLE_COUNT||s.updateCount(r)},flattenChildren:function(e,t){e.children.forEach(function(e){t.push(e),e.children&&t.concat(s.flattenChildren(e,t))})},updateCount:function(e){var a,t=[];e.forEach(function(e){t.push({statement:v.generateTaxonomyCountQuery(e.label)})}),a=e,p.info("Count taxonomies ==>"),c.post({statements:t}).done(function(e){p.info("<== Count taxonomies");for(var t=c.response.parse(e),n=0;n<a.length;n++){var r=t[n][0].count;i.select("#"+a[n].id).select(".ppt-count").text(" ("+r+")")}}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),i.select("#popoto-taxonomy").selectAll(".ppt-count").text(" (0)")})},addTaxonomyChildren:function(e){e.each(function(e){var t=i.select(this),n=e.children;if(e.children){var r=t.append("ul").attr("class","ppt-taxo-sub-ul").selectAll("li").data(n).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-sub-li").attr("value",function(e){return e.label});r.append("span").attr("class",function(e){return"ppt-icon "+R.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),r.append("span").attr("class","ppt-label").text(function(e){return R.taxonomy.getTextValue(e.label)}),r.append("span").attr("class","ppt-count"),r.on("click",s.onClick),s.addTaxonomyChildren(r)}})},onClick:function(){i.event.stopPropagation();var e=this.attributes.value.value;m.nodes.length=0,m.links.length=0,A.node.internalLabels={},f(),A.mainLabel=e,void 0!==R.node.getSchema(e)?A.addSchema(R.node.getSchema(e)):A.addRootNode(e),A.hasGraphChanged=!0,g.hasChanged=!0,A.ignoreCount=!1,f(),n.center()},generateTaxonomiesData:function(){var t=0,e=[];for(var n in R.node.Provider)R.node.Provider.hasOwnProperty(n)&&R.node.getProperty(n,"isSearchable")&&!R.node.Provider[n].parent&&e.push({label:n,id:"popoto-lbl-"+t++});return e.forEach(function(e){R.node.getProvider(e.label).hasOwnProperty("children")&&(t=s.addChildrenData(e,t))}),e},addChildrenData:function(r,a){return r.children=[],R.node.getProvider(r.label).children.forEach(function(e){var t=R.node.getProvider(e),n={label:e,id:"popoto-lbl-"+a++};t.hasOwnProperty("children")&&(a=s.addChildrenData(n,a)),R.node.getProperty(e,"isSearchable")&&r.children.push(n)}),a}},n={CENTER_GRAPH:!0,RESET_GRAPH:!0,SAVE_GRAPH:!1,TOGGLE_TAXONOMY:!1,TOGGLE_FULL_SCREEN:!0,TOGGLE_VIEW_RELATION:!0,TOGGLE_FIT_TEXT:!0,reset:function(){m.nodes.length=0,m.links.length=0,A.node.internalLabels={},"string"==typeof A.mainLabel||A.mainLabel instanceof String?void 0!==R.node.getSchema(A.mainLabel)?A.addSchema(R.node.getSchema(A.mainLabel)):A.addRootNode(A.mainLabel):A.loadSchema(A.mainLabel),A.hasGraphChanged=!0,g.hasChanged=!0,f(),n.center()},center:function(){A.svgTag.transition().call(A.zoom.transform,i.zoomIdentity)},toggleTaxonomy:function(){var e=i.select("#"+s.containerId);e.filter(".disabled").empty()?e.classed("disabled",!0):e.classed("disabled",!1),A.centerRootNode()},toggleFitText:function(){A.USE_FIT_TEXT=!A.USE_FIT_TEXT,A.node.updateNodes()},toggleViewRelation:function(){A.DISABLE_RELATION=!A.DISABLE_RELATION,i.selectAll(".ppt-g-node-background").classed("hide",A.DISABLE_RELATION),A.tick()},toggleFullScreen:function(){var e=document.getElementById(A.containerId);document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},r={TOOL_TAXONOMY:"Show/hide taxonomy panel",TOOL_RELATION:"Show/hide relation",TOOL_CENTER:"Center view",TOOL_FULL_SCREEN:"Full screen",TOOL_RESET:"Reset graph",TOOL_SAVE:"Save graph",TOOL_FIT_TEXT:"Fit text in nodes",render:function(e){var t=e.append("div").attr("class","ppt-toolbar");n.TOGGLE_VIEW_RELATION&&t.append("span").attr("id","popoto-toggle-relation").attr("class","ppt-icon ppt-menu relation").attr("title",t.TOOL_RELATION).on("click",function(){n.toggleViewRelation()}),n.RESET_GRAPH&&t.append("span").attr("id","popoto-reset-menu").attr("class","ppt-icon ppt-menu reset").attr("title",t.TOOL_RESET).on("click",function(){A.notifyListeners(A.Events.GRAPH_RESET,[]),n.reset()}),n.TOGGLE_TAXONOMY&&t.append("span").attr("id","popoto-taxonomy-menu").attr("class","ppt-icon ppt-menu taxonomy").attr("title",t.TOOL_TAXONOMY).on("click",n.toggleTaxonomy),n.CENTER_GRAPH&&t.append("span").attr("id","popoto-center-menu").attr("class","ppt-icon ppt-menu center").attr("title",t.TOOL_CENTER).on("click",n.center),n.TOGGLE_FULL_SCREEN&&t.append("span").attr("id","popoto-fullscreen-menu").attr("class","ppt-icon ppt-menu fullscreen").attr("title",t.TOOL_FULL_SCREEN).on("click",n.toggleFullScreen),n.SAVE_GRAPH&&t.append("span").attr("id","popoto-save-menu").attr("class","ppt-icon ppt-menu save").attr("title",t.TOOL_SAVE).on("click",function(){A.notifyListeners(A.Events.GRAPH_SAVE,[A.getSchema()])}),n.TOGGLE_FIT_TEXT&&t.append("span").attr("id","popoto-fit-text-menu").attr("class","ppt-icon ppt-menu fit-text").attr("title",t.TOOL_FIT_TEXT).on("click",n.toggleFitText)}},a={};a.LinkTypes=Object.freeze({RELATION:0,VALUE:1,SEGMENT:2}),a.TEXT_DY=-4,a.SHOW_MARKER=!1,a.gID="popoto-glinks",a.updateLinks=function(){var e=a.updateData();a.removeElements(e.exit()),a.addNewElements(e.enter()),a.updateElements()},a.updateData=function(){return A.svg.select("#"+a.gID).selectAll(".ppt-glink").data(m.links,function(e){return e.id})},a.removeElements=function(e){e.remove()},a.addNewElements=function(e){var t=e.append("g").attr("class","ppt-glink").on("click",a.clickLink).on("mouseover",a.mouseOverLink).on("mouseout",a.mouseOutLink);t.append("path").attr("class","ppt-link"),t.append("text").attr("text-anchor","middle").attr("dy",a.TEXT_DY).append("textPath").attr("class","ppt-textPath").attr("startOffset","50%")},a.updateElements=function(){var e=A.svg.select("#"+a.gID).selectAll(".ppt-glink");e.attr("id",function(e){return"ppt-glink_"+e.id}),e.selectAll(".ppt-link").attr("id",function(e){return"ppt-path_"+e.id}).attr("stroke",function(e){return R.link.getColor(e,"path","stroke")}).attr("class",function(e){return"ppt-link "+R.link.getCSSClass(e,"path")}),e.selectAll("text").attr("id",function(e){return"ppt-text_"+e.id}).attr("class",function(e){return R.link.getCSSClass(e,"text")}).attr("fill",function(e){return R.link.getColor(e,"text","fill")}).selectAll(".ppt-textPath").attr("id",function(e){return"ppt-textpath_"+e.id}).attr("class",function(e){return"ppt-textpath "+R.link.getCSSClass(e,"text-path")}).attr("xlink:href",function(e){return"#ppt-path_"+e.id}).text(function(e){return R.link.getTextValue(e)})},a.mouseOverLink=function(){i.select(this).select("path").attr("class",function(e){return"ppt-link "+R.link.getCSSClass(e,"path--hover")}),i.select(this).select("text").attr("class",function(e){return R.link.getCSSClass(e,"text--hover")});var t=i.select(this).data()[0];N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!0),N.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!0)),T.isActive&&T.querySpanElements.filter(function(e){return e.link===t}).classed("hover",!0)},a.mouseOutLink=function(){i.select(this).select("path").attr("class",function(e){return"ppt-link "+R.link.getCSSClass(e,"path")}),i.select(this).select("text").attr("class",function(e){return R.link.getCSSClass(e,"text")});var t=i.select(this).data()[0];N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!1),N.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!1)),T.isActive&&T.querySpanElements.filter(function(e){return e.link===t}).classed("hover",!1)},a.clickLink=function(){var e=i.select(this).data()[0];if(e.type!==a.LinkTypes.VALUE){A.node.collapseAllNode();var t=A.node.removeNode(e.target);A.hasGraphChanged=!0,g.hasChanged=t,f()}};var l={},u=document.createElement("canvas").getContext("2d");function h(e){return u.measureText(e).width}l.getNodeBoundingBox=function(e){return e.getBBox()},l.render=function(e){var t=e.append("rect").attr("fill",function(e){return R.node.getColor(e,"back-text","fill")}).attr("class",function(e){return R.node.getCSSClass(e,"back-text")}),n=e.append("text").attr("class",function(e){return R.node.getCSSClass(e,"text")});n.attr("style","text-anchor: middle; font: 10px sans-serif").datum(function(e){var t=function(e){if(null==e)return{lines:[]};var t=(e=String(e)).split(/\s+/g);t[t.length-1]||t.pop(),t[0]||t.shift();for(var n,r=Math.sqrt(12*h(e.trim())),a=1/0,o=[],l=0,i=t.length;l<i;++l){var s=(n?n.text+" ":"")+t[l],u=h(s);(a+u)/2<r?(n.width=a=u,n.text=s):(n={width:a=h(t[l]),text:t[l]},o.push(n))}var d=0;for(l=0,i=o.length;l<i;++l){var p=12*(Math.abs(l-i/2+.5)+.5),c=o[l].width/2;d=Math.max(d,Math.sqrt(c*c+p*p))}return{lines:o.map(function(e){return{text:e.text,linesLength:o.length}}),textRadius:d}}(R.node.getTextValue(e));return e.lines=t.lines,e.textRadius=t.textRadius,e}),n.selectAll("tspan").data(function(e){return e.lines}).enter().append("tspan").attr("x",0).attr("y",function(e,t,n){return 12*(t-e.linesLength/2+.8)}).text(function(e){return e.text}),n.attr("transform",function(e){var t=1;return 0!==e.textRadius&&e.textRadius&&(t=R.node.getSize(e)/e.textRadius),"translate(0,0) scale("+t+")"}),t.attr("x",function(e){return l.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return l.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return l.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return l.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).height}).attr("transform",function(e){return i.select(this.parentNode).select("text").attr("transform")})};var E={TEXT_Y:8,getNodeBoundingBox:function(e){return e.getBBox()},render:function(e){var t=e.append("rect").attr("fill",function(e){return R.node.getColor(e,"back-text","fill")}).attr("class",function(e){return R.node.getCSSClass(e,"back-text")});e.append("text").attr("x",0).attr("y",E.TEXT_Y).attr("text-anchor","middle").attr("class",function(e){return R.node.getCSSClass(e,"text")}).on("mouseover",function(e){i.select(this.parentNode).attr("clip-path",null)}).on("mouseout",function(e){i.select(this.parentNode).attr("clip-path",function(e){return"url(#node-view"+e.id+")"})}).text(function(e){return R.node.getTextValue(e)}),t.attr("x",function(e){return E.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return E.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return E.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return E.getNodeBoundingBox(i.select(this.parentNode).select("text").node()).height})}},y={gID:"popoto-gnodes",DONUTS_MARGIN:0,DONUT_WIDTH:20,NODE_MAX_CHARS:11,NODE_TITLE_MAX_CHARS:100,PAGE_SIZE:10,CountBox:{x:16,y:33,w:52,h:19},chooseWaiting:!1,getDonutInnerRadius:function(e){return R.node.getSize(e)+y.DONUTS_MARGIN},getDonutOuterRadius:function(e){return R.node.getSize(e)+y.DONUTS_MARGIN+y.DONUT_WIDTH}};y.pie=i.pie().sort(null).value(function(e){return 1}),y.NodeTypes=Object.freeze({ROOT:0,CHOOSE:1,VALUE:2,GROUP:3}),y.internalLabels={},y.generateInternalLabel=function(e){var t=e?e.toLowerCase().replace(/ /g,""):"n";return t in y.internalLabels?(y.internalLabels[t]=y.internalLabels[t]+1,t+y.internalLabels[t]):(y.internalLabels[t]=0,t)},y.updateNodes=function(){var e=y.updateData();y.removeElements(e.exit()),y.addNewElements(e.enter()),y.updateElements()},y.updateData=function(){var e=A.svg.select("#"+y.gID).selectAll(".ppt-gnode").data(m.nodes,function(e){return e.id});return A.hasGraphChanged&&(y.updateAutoLoadValues(),A.DISABLE_COUNT||A.ignoreCount||y.updateCount()),A.hasGraphChanged=!1,e},y.updateCount=function(){void 0!==y.updateCountXhr&&y.updateCountXhr.abort();var n=[],r=m.nodes.filter(function(e){return!(e.type===y.NodeTypes.VALUE||e.type===y.NodeTypes.GROUP||e.hasOwnProperty("isNegative")&&e.isNegative)});r.forEach(function(e){var t=v.generateNodeCountQuery(e);n.push({statement:t.statement,parameters:t.parameters})}),p.info("Count nodes ==>"),y.updateCountXhr=c.post({statements:n}).done(function(e){p.info("<== Count nodes");for(var t=c.response.parse(e),n=0;n<r.length;n++)r[n].count=t[n][0].count;0<g.resultCountListeners.length&&g.updateResultsCount(),y.updateElements(),A.link.updateElements()}).fail(function(e,t,n){"abort"!==t?(p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r.forEach(function(e){e.count=0}),y.updateElements(),A.link.updateElements()):p.info("<=X= Count nodes - Aborted!")})},y.updateAutoLoadValues=function(){for(var e=[],o=y.getAutoLoadValueNodes(),t=0;t<o.length;t++){var n=o[t],r=v.generateNodeValueQuery(n);e.push({statement:r.statement,parameters:r.parameters})}0<e.length&&(p.info("AutoLoadValue ==>"),c.post({statements:e}).done(function(e){p.info("<== AutoLoadValue");for(var t=c.response.parse(e),n=0;n<o.length;n++){var r=o[n],a=R.node.getConstraintAttribute(r.label);r.data=t[n].filter(function(t){var n=!0;return r.hasOwnProperty("value")&&0<r.value.length&&r.value.forEach(function(e){e.attributes[a]===t[a]&&(n=!1)}),n}),r.page=1}A.notifyListeners(A.Events.GRAPH_NODE_DATA_LOADED,[o])}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)}))},y.removeElements=function(e){e.filter(function(e){return!e.parent}).remove(),e.filter(function(e){return e.parent}).transition().duration(300).attr("transform",function(e){return"translate("+e.parent.x+","+e.parent.y+")"}).remove()},y.addNewElements=function(e){var t=e.append("g").attr("class","ppt-gnode");t.on("click",y.nodeClick).on("mouseover",y.mouseOverNode).on("mouseout",y.mouseOutNode),t.filter(function(e){return e.type!==y.NodeTypes.VALUE}).on("contextmenu",y.clearSelection),t.filter(function(e){return e.type===y.NodeTypes.VALUE}).on("contextmenu",function(){i.event.preventDefault()}),t.append("defs").append("clipPath").attr("id",function(e){return"node-view"+e.id}).append("circle").attr("cx",0).attr("cy",0),y.addBackgroundElements(t),y.addMiddlegroundElements(t),y.addForegroundElements(t)},y.addBackgroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-background").classed("hide",A.DISABLE_RELATION);t.append("g").attr("class","ppt-donut-labels"),t.append("g").attr("class","ppt-donut-segments")},y.addMiddlegroundElements=function(e){e.append("g").attr("class","ppt-g-node-middleground")},y.addForegroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-foreground"),n=t.filter(function(e){return e.type===y.NodeTypes.ROOT||e.type===y.NodeTypes.CHOOSE}).append("g").attr("class","ppt-node-foreground-g-arrows"),r=n.append("g");r.append("circle").attr("class","ppt-larrow").attr("cx","-43").attr("cy","-23").attr("r","17"),r.append("path").attr("class","ppt-arrow").attr("d","m -44.905361,-23 6.742,-6.742 c 0.81,-0.809 0.81,-2.135 0,-2.944 l -0.737,-0.737 c -0.81,-0.811 -2.135,-0.811 -2.945,0 l -8.835,8.835 c -0.435,0.434 -0.628,1.017 -0.597,1.589 -0.031,0.571 0.162,1.154 0.597,1.588 l 8.835,8.834 c 0.81,0.811 2.135,0.811 2.945,0 l 0.737,-0.737 c 0.81,-0.808 0.81,-2.134 0,-2.943 l -6.742,-6.743 z"),r.on("click",function(e){i.event.stopPropagation(),1<e.page&&(e.page--,y.collapseNode(e),y.expandNode(e))});var a=n.append("g");if(a.append("circle").attr("class","ppt-rarrow").attr("cx","43").attr("cy","-23").attr("r","17"),a.append("path").attr("class","ppt-arrow").attr("d","m 51.027875,-24.5875 -8.835,-8.835 c -0.811,-0.811 -2.137,-0.811 -2.945,0 l -0.738,0.737 c -0.81,0.81 -0.81,2.136 0,2.944 l 6.742,6.742 -6.742,6.742 c -0.81,0.81 -0.81,2.136 0,2.943 l 0.737,0.737 c 0.81,0.811 2.136,0.811 2.945,0 l 8.835,-8.836 c 0.435,-0.434 0.628,-1.017 0.597,-1.588 0.032,-0.569 -0.161,-1.152 -0.596,-1.586 z"),a.on("click",function(e){i.event.stopPropagation(),e.page*y.PAGE_SIZE<e.count&&(e.page++,y.collapseNode(e),y.expandNode(e))}),!A.DISABLE_COUNT){var o=t.filter(function(e){return e.type!==y.NodeTypes.GROUP});o.append("rect").attr("x",y.CountBox.x).attr("y",y.CountBox.y).attr("width",y.CountBox.w).attr("height",y.CountBox.h).attr("class","ppt-count-box"),o.append("text").attr("x",42).attr("y",48).attr("text-anchor","middle").attr("class","ppt-count-text")}t.filter(function(e){return e.type===y.NodeTypes.CHOOSE}).append("g").attr("class","ppt-g-node-ban").append("path").attr("d","M89.1 19.2C88 17.7 86.6 16.2 85.2 14.8 83.8 13.4 82.3 12 80.8 10.9 72 3.9 61.3 0 50 0 36.7 0 24.2 5.4 14.8 14.8 5.4 24.2 0 36.7 0 50c0 11.4 3.9 22.1 10.9 30.8 1.2 1.5 2.5 3 3.9 4.4 1.4 1.4 2.9 2.7 4.4 3.9C27.9 96.1 38.6 100 50 100 63.3 100 75.8 94.6 85.2 85.2 94.6 75.8 100 63.3 100 50 100 38.7 96.1 28 89.1 19.2ZM11.9 50c0-10.2 4-19.7 11.1-27C30.3 15.9 39.8 11.9 50 11.9c8.2 0 16 2.6 22.4 7.3L19.3 72.4C14.5 66 11.9 58.2 11.9 50Zm65 27c-7.2 7.1-16.8 11.1-27 11.1-8.2 0-16-2.6-22.4-7.4L80.8 27.6C85.5 34 88.1 41.8 88.1 50c0 10.2-4 19.7-11.1 27z")},y.updateElements=function(){var e=A.svg.select("#"+y.gID).selectAll(".ppt-gnode");e.attr("id",function(e){return"popoto-gnode_"+e.id}),A.USE_VORONOI_LAYOUT&&e.attr("clip-path",function(e){return"url(#voroclip-"+e.id+")"}),e.select("defs").select("clipPath").attr("id",function(e){return"node-view"+e.id}).selectAll("circle").attr("r",function(e){return R.node.getSize(e)}),e.filter(function(e){return e.type!==y.NodeTypes.ROOT}).call(i.drag().on("start",function(e){i.event.active||A.force.alphaTarget(.3).restart();e.fx=e.x,e.fy=e.y}).on("drag",function(e){e.fx=i.event.x,e.fy=i.event.y}).on("end",function(e){i.event.active||A.force.alphaTarget(0);!1===e.fixed&&(e.fx=null,e.fy=null)})),y.updateBackgroundElements(),y.updateMiddlegroundElements(),y.updateForegroundElements()},y.updateBackgroundElements=function(){var e=A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-background");e.select(".ppt-donut-labels").selectAll("*").remove(),e.select(".ppt-donut-segments").selectAll("*").remove();var t=e.select(".ppt-donut-segments").selectAll(".ppt-segment-container").data(function(e){var t=[];return e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",y.segmentClick).on("mouseover",function(e){i.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){i.select(this).select(".ppt-text-arc").classed("hover",!1)});t.append("title").attr("class","ppt-svg-title").text(function(e){return e.label+" "+e.target}),e.select(".ppt-donut-labels").selectAll(".ppt-segment-container").data(function(e){var t=[];return e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",y.segmentClick).on("mouseover",function(e){i.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){i.select(this).select(".ppt-text-arc").classed("hover",!1)}).append("path").attr("class","ppt-hidden-arc").attr("id",function(e,t){return"arc_"+i.select(this.parentNode.parentNode).datum().id+"_"+t}).attr("d",function(e){var t=i.select(this.parentNode.parentNode).datum(),n={startAngle:e.directionAngle-(Math.PI-.1),endAngle:e.directionAngle+(Math.PI-.1)},r=i.arc().innerRadius(y.getDonutInnerRadius(t)).outerRadius(y.getDonutOuterRadius(t))(n),a=/(^.+?)L/.exec(r);return(a&&1<a.length?a[1]:/(^.+?)M/.exec(r)[1]).replace(/,/g," ")}).style("fill","none").style("stroke","none"),t.append("text").attr("text-anchor","middle").attr("class",function(e){var t=i.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-text-arc disabled":"ppt-text-arc"}).attr("fill",function(e){var t=i.select(this.parentNode.parentNode).datum();return R.link.getColor({label:e.label,type:A.link.LinkTypes.SEGMENT,source:t,target:{label:e.target}},"segment","fill")}).attr("dy",A.link.TEXT_DY).append("textPath").attr("startOffset","50%").attr("xlink:href",function(e,t){return"#arc_"+i.select(this.parentNode.parentNode.parentNode).datum().id+"_"+t}).text(function(e){var t=i.select(this.parentNode.parentNode.parentNode).datum();return R.link.getTextValue({source:t,target:{label:e.target},label:e.label,type:A.link.LinkTypes.SEGMENT})}),t.append("path").attr("class",function(e){var t=i.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-segment disabled":"ppt-segment"}).attr("d",function(e){var t=i.select(this.parentNode.parentNode).datum();return i.arc().innerRadius(y.getDonutInnerRadius(t)).outerRadius(y.getDonutOuterRadius(t))(e)}).attr("fill",function(e){var t=i.select(this.parentNode.parentNode).datum();return R.link.getColor({label:e.label,type:A.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","fill")}).attr("stroke",function(e){var t=i.select(this.parentNode.parentNode).datum();return R.link.getColor({label:e.label,type:A.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","stroke")})},y.updateMiddlegroundElements=function(){var e=A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-middleground");e.attr("clip-path",function(e){return"url(#node-view"+e.id+")"}),e.selectAll("*").remove(),y.updateMiddlegroundElementsTooltip(e),y.updateMiddlegroundElementsText(e.filter(function(e){return R.node.getNodeDisplayType(e)===R.node.DisplayTypes.TEXT})),y.updateMiddlegroundElementsImage(e.filter(function(e){return R.node.getNodeDisplayType(e)===R.node.DisplayTypes.IMAGE})),y.updateMiddlegroundElementsSymbol(e.filter(function(e){return R.node.getNodeDisplayType(e)===R.node.DisplayTypes.SYMBOL})),y.updateMiddlegroundElementsSVG(e.filter(function(e){return R.node.getNodeDisplayType(e)===R.node.DisplayTypes.SVG})),y.updateMiddlegroundElementsDisplayedText(e.filter(function(e){return R.node.isTextDisplayed(e)}))},y.updateMiddlegroundElementsTooltip=function(e){e.append("title").attr("class",function(e){return R.node.getCSSClass(e,"title")}).text(function(e){return R.node.getTextValue(e,y.NODE_TITLE_MAX_CHARS)})},y.updateMiddlegroundElementsText=function(e){e.append("circle").attr("r",function(e){return R.node.getSize(e)}).attr("class",function(e){return R.node.getCSSClass(e,"circle")}).attr("fill",function(e){return R.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return R.node.getColor(e,"circle","stroke")})},y.updateMiddlegroundElementsImage=function(e){e.append("circle").attr("r",function(e){return R.node.getSize(e)}).attr("class",function(e){return R.node.getCSSClass(e,"image-background-circle")}),e.append("image").attr("class",function(e){return R.node.getCSSClass(e,"image")}).attr("width",function(e){return R.node.getImageWidth(e)}).attr("height",function(e){return R.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-R.node.getImageWidth(e)/2+","+-R.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return R.node.getImagePath(e)})},y.updateMiddlegroundElementsSymbol=function(e){e.append("circle").attr("r",function(e){return R.node.getSize(e)}).attr("class",function(e){return R.node.getCSSClass(e,"symbol-background-circle")}).attr("fill",function(e){return R.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return R.node.getColor(e,"circle","stroke")}),e.append("use").attr("class",function(e){return R.node.getCSSClass(e,"symbol")}).attr("width",function(e){return R.node.getImageWidth(e)}).attr("height",function(e){return R.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-R.node.getImageWidth(e)/2+","+-R.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return R.node.getImagePath(e)}).attr("fill",function(e){return R.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return R.node.getColor(e,"circle","stroke")})},y.updateMiddlegroundElementsSVG=function(e){var t=e.append("g"),n=(t.append("circle").attr("r",function(e){return R.node.getSize(e)}).attr("class","ppt-svg-node-background"),t.selectAll("path").data(function(e){return R.node.getSVGPaths(e)}));n.exit().remove(),n.enter().append("path"),t.selectAll("path").attr("class",function(e){var t=i.select(this.parentNode).datum();return R.node.getCSSClass(t,"path")}).each(function(e,t){for(var n in e)e.hasOwnProperty(n)&&i.select(this).attr(n,e[n])})},y.updateMiddlegroundElementsDisplayedText=function(e){var t=e.filter(function(e){return R.node.isTextDisplayed(e)});A.USE_FIT_TEXT?l.render(t):E.render(t)},y.updateForegroundElements=function(){var e=A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-node-foreground-g-arrows");e.classed("active",function(e){return e.valueExpanded&&e.data&&e.data.length>y.PAGE_SIZE}),e.selectAll(".ppt-larrow").classed("enabled",function(e){return 1<e.page}),e.selectAll(".ppt-rarrow").classed("enabled",function(e){if(e.data){var t=e.data.length;return e.page*y.PAGE_SIZE<t}return!1});var t=A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground");t.selectAll(".ppt-count-box").filter(function(e){return e.type!==y.NodeTypes.CHOOSE}).classed("root",!0),t.selectAll(".ppt-count-box").filter(function(e){return e.type===y.NodeTypes.CHOOSE}).classed("value",!0),t.selectAll(".ppt-count-box").classed("disabled",function(e){return 0===e.count}),A.DISABLE_COUNT||t.selectAll(".ppt-count-text").text(function(e){return null!==e.count?e.count:"..."}).classed("disabled",function(e){return 0===e.count}),A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").filter(function(e){return!0===e.isNegative}).selectAll(".ppt-g-node-ban").attr("transform",function(e){return"translate("+-R.node.getSize(e)+","+-R.node.getSize(e)+") scale("+2*R.node.getSize(e)/100+")"}).attr("stroke-width",function(e){return 2/(2*R.node.getSize(e)/100)+"px"}),A.svg.select("#"+y.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-g-node-ban").classed("active",function(e){return!0===e.isNegative})},y.segmentClick=function(e){i.event.preventDefault();var t=i.select(this.parentNode.parentNode).datum();A.ignoreCount=!0,A.addRelationshipData(t,e,function(){A.ignoreCount=!1,A.hasGraphChanged=!0,f()})},y.mouseOverNode=function(){i.event.preventDefault();var t=i.select(this).data()[0];N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!0),N.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!0)),T.isActive&&T.querySpanElements.filter(function(e){return e.node===t}).classed("hover",!0)},y.mouseOutNode=function(){i.event.preventDefault();var t=i.select(this).data()[0];N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!1),N.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!1)),T.isActive&&T.querySpanElements.filter(function(e){return e.node===t}).classed("hover",!1)},y.nodeClick=function(){if(!i.event.defaultPrevented){var e=i.select(this).data()[0];if(p.debug("nodeClick ("+e.label+")"),e.type===y.NodeTypes.VALUE)y.valueNodeClick(e);else if(e.type===y.NodeTypes.CHOOSE||e.type===y.NodeTypes.ROOT)if(i.event.ctrlKey){if(e.type===y.NodeTypes.CHOOSE){if(e.isNegative=!e.hasOwnProperty("isNegative")||!e.isNegative,y.collapseAllNode(),e.hasOwnProperty("value")&&0<e.value.length);else if(e.isNegative){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&y.removeNode(m.links[t].target);e.count=0}g.hasChanged=!0,A.hasGraphChanged=!0,f()}}else e.valueExpanded?y.collapseNode(e):y.chooseNodeClick(e)}},y.collapseNode=function(t){if(t.valueExpanded){p.debug("collapseNode ("+t.label+")"),A.notifyListeners(A.Events.GRAPH_NODE_VALUE_COLLAPSE,[t]);var e=m.links.filter(function(e){return e.source===t&&e.type===A.link.LinkTypes.VALUE});e.forEach(function(e){m.nodes.splice(m.nodes.indexOf(e.target),1)});for(var n=m.links.length-1;0<=n;n--)0<=e.indexOf(m.links[n])&&m.links.splice(n,1);t.type!==y.NodeTypes.ROOT&&(t.fixed=!1,t.fx=null,t.fy=null),t.parent&&t.parent.type!==y.NodeTypes.ROOT&&(t.parent.fixed=!1,t.parent.fx=null,t.parent.fy=null),t.valueExpanded=!1,f()}else p.debug("collapseNode called on an unexpanded node")},y.collapseAllNode=function(){m.nodes.forEach(function(e){e.type!==y.NodeTypes.CHOOSE&&e.type!==y.NodeTypes.ROOT||!e.valueExpanded||y.collapseNode(e)})},y.valueNodeClick=function(e){p.debug("valueNodeClick ("+e.label+")"),A.notifyListeners(A.Events.GRAPH_NODE_ADD_VALUE,[e]),void 0===e.parent.value&&(e.parent.value=[]),e.parent.value.push(e),g.hasChanged=!0,A.hasGraphChanged=!0,y.collapseNode(e.parent)},y.chooseNodeClick=function(a){if(p.debug("chooseNodeClick ("+a.label+") with waiting state set to "+y.chooseWaiting),!y.chooseWaiting&&!a.immutable&&0!==a.count)if(y.collapseAllNode(),y.chooseWaiting=!0,void 0!==a.data&&a.isAutoLoadValue)a.page=1,y.expandNode(a),y.chooseWaiting=!1;else{p.info("Values ("+a.label+") ==>");var e=v.generateNodeValueQuery(a);c.post({statements:[{statement:e.statement,parameters:e.parameters}]}).done(function(e){p.info("<== Values ("+a.label+")");var t=c.response.parse(e),r=R.node.getConstraintAttribute(a.label);a.data=t[0].filter(function(t){var n=!0;return a.hasOwnProperty("value")&&0<a.value.length&&a.value.forEach(function(e){e.attributes[r]===t[r]&&(n=!1)}),n}),a.page=1,y.expandNode(a),y.chooseWaiting=!1}).fail(function(e,t,n){y.chooseWaiting=!1,p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})}},y.addExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=m.nodes[r].data.length-1;0<=a;a--)m.nodes[r].data[a][e]===t&&(n=!0,m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]),m.nodes[r].value.push({attributes:m.nodes[r].data[a]}),m.nodes[r].data.splice(a,1));y.collapseNode(m.nodes[r]),y.expandNode(m.nodes[r])}n&&(g.hasChanged=!0,A.hasGraphChanged=!0,f())},y.getContainingValue=function(n){var r=[],e=m.links,t=m.nodes;if(0<t.length){var a=t[0];void 0!==a.value&&0<a.value.length&&(void 0!==n&&n!==a.label||r.push(a)),e.forEach(function(e){var t=e.target;e.type===A.link.LinkTypes.RELATION&&void 0!==t.value&&0<t.value.length&&(void 0!==n&&n!==t.label||r.push(t))})}return r},y.addValueForLabel=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].type===y.NodeTypes.CHOOSE&&m.nodes[r].label===e){m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]);var a=!1,o=R.node.getConstraintAttribute(e);m.nodes[r].value.forEach(function(e){e.attributes.hasOwnProperty(o)&&e.attributes[o]===t.attributes[o]&&(a=!0)}),a||(m.nodes[r].value.push(t),n=!0)}return n},y.addValue=function(e,t){for(var n=!1,r=0;r<m.nodes.length;r++){var a=m.nodes[r];if(0<=e.indexOf(a.id)){a.hasOwnProperty("value")||(a.value=[]);var o=R.node.getReturnAttributes(a.label)[0];a.data.forEach(function(e){e.hasOwnProperty(o)&&e[o]===t&&(n=!0,a.value.push({attributes:e}))})}}n&&(g.hasChanged=!0,A.hasGraphChanged=!0,f())},y.removeValue=function(e,t){for(var n=!1,r=e.value.length-1;0<=r;r--)e.value[r]===t&&(y.collapseNode(e),e.value.splice(r,1),n=!0);return n},y.getValue=function(e,t){for(var n=0;n<m.nodes.length;n++){var r=m.nodes[n];if(r.id===e)for(var a=R.node.getConstraintAttribute(r.label),o=r.value.length-1;0<=o;o--)if(r.value[o].attributes[a]===t)return r.value[o]}},y.removeExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=[],o=m.nodes[r].value.length-1;0<=o;o--)m.nodes[r].value[o].attributes[e]===t&&(n=!0,a=a.concat(m.nodes[r].value.splice(o,1)));for(var l=0;l<a.length;l++)m.nodes[r].data.push(a[l].attributes);y.collapseNode(m.nodes[r]),y.expandNode(m.nodes[r])}n&&(g.hasChanged=!0,A.hasGraphChanged=!0,f())},y.getAutoLoadValueNodes=function(){return m.nodes.filter(function(e){return e.hasOwnProperty("isAutoLoadValue")&&!0===e.isAutoLoadValue&&!(!0===e.isNegative)})},y.addRelatedValues=function(u,e,d){var t=y.filterExistingValues(u,e);if(!(t.length<=0)){var o=[];t.forEach(function(e){var t=R.node.getConstraintAttribute(e.label),n="MATCH ";t===v.NEO4J_INTERNAL_ID?n+="(v:`"+e.label+"`) WHERE (ID(v) = $p)":n+="(v:`"+e.label+"`) WHERE (v."+t+" = $p)";var r=R.node.getReturnAttributes(e.label),a="";n+=' RETURN DISTINCT "'+e.rel+'" AS rel, "'+e.label+'" AS label, {'+r.reduce(function(e,t){return e+=a+t+":v."+t,a=", ",e},"")+"} AS value LIMIT 1",o.push({statement:n,parameters:{p:e.id},resultDataContents:["row"]})}),p.info("addRelatedValues ==>"),c.post({statements:o}).done(function(e){p.info("<== addRelatedValues");var i=c.response.parse(e),s=0;i.forEach(function(e){if(0<e.length){var t=e[0].label,n=e[0].value,r=e[0].rel,a={id:m.generateId(),parent:u,attributes:n,type:y.NodeTypes.VALUE,label:t};A.ignoreCount=!0;var o=u.relationships.filter(function(e){return e.label===r&&e.target===t}),l={label:r,target:t};0<o.length&&(l=o[0]),A.addRelationshipData(u,l,function(){++s===i.length&&(A.ignoreCount=!1,A.hasGraphChanged=!0,g.hasChanged=!0,f())},[a],d)}})}).fail(function(e,t,n){console.error(e,t,n)})}},y.addRelatedBranch=function(e,t,n,r){if(0<t.length){var a=t[0];t=t.slice(1);var o=e.relationships.filter(function(e){return e.label===a.type&&e.target===a.target});0<o.length&&A.addRelationshipData(e,o[0],function(e){y.addRelatedBranch(e,t,n,r)})}else y.addRelatedValues(e,n,r)},y.filterExistingValues=function(e,t){var a=[],o=m.nodes.filter(function(e){return e.parent===e&&e.hasOwnProperty("value")&&0<e.value.length});return t.forEach(function(t){var n=!1,r=R.node.getConstraintAttribute(t.label);o.forEach(function(e){e.label===t.label&&e.value.forEach(function(e){e.attributes[r]===t.id&&(n=!0)})}),n||a.push(t)}),a},y.expandNode=function(o){A.notifyListeners(A.Events.GRAPH_NODE_VALUE_EXPAND,[o]);var e=o.page*y.PAGE_SIZE,t=e-y.PAGE_SIZE,l=o.data.slice(t,e),i=A.computeParentAngle(o),s=1;l.forEach(function(e){var t;t=o.parent?360/(l.length+1)*s:360/l.length*s;var n=o.x+100*Math.cos(t*(Math.PI/180)-i),r=o.y+100*Math.sin(t*(Math.PI/180)-i),a={id:m.generateId(),parent:o,attributes:e,type:y.NodeTypes.VALUE,label:o.label,count:e.count,x:n,y:r,internalID:e[v.NEO4J_INTERNAL_ID.queryInternalName]};m.nodes.push(a),m.links.push({id:"l"+m.generateId(),source:o,target:a,type:A.link.LinkTypes.VALUE}),s++}),o.fixed=!0,o.fx=o.x,o.fy=o.y,o.parent&&o.parent.type!==y.NodeTypes.ROOT&&(o.parent.fixed=!0,o.parent.fx=o.parent.x,o.parent.fy=o.parent.y),o.valueExpanded=!0,f()},y.loadRelationshipData=function(n,r,a){var e=R.node.getSchema(n.label);if(void 0!==e)e.hasOwnProperty("rel")&&0<e.rel.length?r(y.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(e.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})):r([]);else{var t=v.generateNodeRelationQuery(n);p.info("Relations ("+n.label+") ==>"),c.post({statements:[{statement:t.statement,parameters:t.parameters}]}).done(function(e){p.info("<== Relations ("+n.label+")");var t=c.response.parse(e)[0].filter(function(e){return v.filterRelation(e)});t=y.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(t).map(function(e){return{id:e.data.label+e.data.target,label:e.data.label,target:e.data.target,count:e.data.count,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}}),r(t)}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r([])})}},y.expandRelationships=function(e,t){var n=0;if(e.hasOwnProperty("relationships")&&0<e.relationships.length)for(var r=0;r<e.relationships.length;r++)A.addRelationshipData(e,e.relationships[r],function(){++n===e.relationships.length&&t()});else t()},y.removeNode=function(t){var n=t.hasOwnProperty("value")&&0<t.value.length;m.links.filter(function(e){return e.source===t}).forEach(function(e){var t=y.removeNode(e.target);n=n||t});for(var e=m.links.length-1;0<=e;e--)m.links[e].target===t&&m.links.splice(e,1);return m.nodes.splice(m.nodes.indexOf(t),1),n},y.clearSelection=function(){i.event.preventDefault();var e=i.select(this).data()[0];if(y.collapseAllNode(),void 0!==e.value&&0<e.value.length&&!e.immutable){if(e.value.pop(),!0===e.isNegative&&0===e.value.length){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&y.removeNode(m.links[t].target);e.count=0}g.hasChanged=!0,A.hasGraphChanged=!0,f()}};var A={};A.link=a,A.node=y,A.DISABLE_RELATION=!1,A.DISABLE_COUNT=!1,A.containerId="popoto-graph",A.hasGraphChanged=!0,A.zoom=i.zoom().scaleExtent([.1,10]),A.WHEEL_ZOOM_ENABLED=!0,A.USE_DONUT_FORCE=!1,A.USE_VORONOI_LAYOUT=!1,A.USE_FIT_TEXT=!1,A.Events=Object.freeze({NODE_ROOT_ADD:"root.node.add",NODE_EXPAND_RELATIONSHIP:"node.expandRelationship",GRAPH_SAVE:"graph.save",GRAPH_RESET:"graph.reset",GRAPH_NODE_VALUE_EXPAND:"graph.node.value_expand",GRAPH_NODE_VALUE_COLLAPSE:"graph.node.value_collapse",GRAPH_NODE_ADD_VALUE:"graph.node.add_value",GRAPH_NODE_DATA_LOADED:"graph.node.data_loaded"}),A.listeners={},A.on=function(e,t){A.listeners.hasOwnProperty(e)||(A.listeners[e]=[]),A.listeners[e].push(t)},A.notifyListeners=function(t,n){A.listeners.hasOwnProperty(t)&&A.listeners[t].forEach(function(e){e.apply(t,n)})},A.onSave=function(e){A.on(A.Events.GRAPH_SAVE,e)},A.onReset=function(e){A.on(A.Events.GRAPH_RESET,e)},A.setDefaultGraph=function(e){e.mainLabel=e},A.createGraphArea=function(){var e=i.select("#"+A.containerId);r.render(e),A.svgTag=e.append("svg").attr("class","ppt-svg-graph").call(A.zoom.on("zoom",A.rescale)),A.svgTag.on("dblclick.zoom",null),A.WHEEL_ZOOM_ENABLED||A.svgTag.on("wheel.zoom",null).on("mousewheel.zoom",null),A.svgdefs=A.svgTag.append("defs"),A.svgdefs.append("marker").attr("id","cross").attr("refX",10).attr("refY",10).attr("markerWidth",20).attr("markerHeight",20).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-cross").attr("d","M5,5 L15,15 M15,5 L5,15"),A.svgdefs.append("marker").attr("id","arrow").attr("refX",9).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-arrow").attr("d","M0,0 L0,6 L9,3 z"),A.svgdefs.append("marker").attr("id","reverse-arrow").attr("refX",0).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-reverse-arrow").attr("d","M0,3 L9,6 L9,0 z"),A.svgdefs.append("filter").attr("id","grayscale").append("feColorMatrix").attr("type","saturate").attr("values","0");var t=A.svgdefs.append("filter").attr("id","gooey");t.append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","10").attr("color-interpolation-filters","sRGB").attr("result","blur"),t.append("feColorMatrix").attr("class","blurValues").attr("in","blur").attr("mode","matrix").attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 35 -6").attr("result","gooey"),t.append("feBlend").attr("in","SourceGraphic").attr("in2","gooey").attr("operator","atop"),A.svgdefs.append("g").attr("id","voronoi-clip-path"),A.svg=A.svgTag.append("svg:g"),A.svg.append("g").attr("id",A.link.gID),A.svg.append("g").attr("id",A.node.gID),window.addEventListener("resize",A.centerRootNode)},A.getRootNode=function(){return m.getRootNode()},A.centerRootNode=function(){m.getRootNode().fx=A.getSVGWidth()/2,m.getRootNode().fy=A.getSVGHeight()/2,f()},A.getSVGWidth=function(){return void 0===A.svg||A.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(A.containerId).clientWidth},A.getSVGHeight=function(){return void 0===A.svg||A.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(A.containerId).clientHeight},A.rescale=function(){A.svg.attr("transform",i.event.transform)},A.CHARGE=-500,A.createForceLayout=function(){A.force=i.forceSimulation().force("charge",i.forceManyBody().strength(function(e){return e.charge?e.charge:A.CHARGE})).force("link",i.forceLink().id(function(e){return e.id}).distance(R.link.getDistance)),A.force.nodes(m.nodes),A.force.force("link").links(m.links),A.force.on("tick",A.tick)},A.addRootNode=function(t){if(0<m.nodes.length&&p.warn("graph.addRootNode is called but the graph is not empty."),void 0!==R.node.getSchema(t))A.addSchema(R.node.getSchema(t));else{var n={id:m.generateId(),type:A.node.NodeTypes.ROOT,x:A.getSVGWidth()/2,y:A.getSVGHeight()/2,fx:A.getSVGWidth()/2,fy:A.getSVGHeight()/2,tx:A.getSVGWidth()/2,ty:A.getSVGHeight()/2,label:t,fixed:!0,internalLabel:A.node.generateInternalLabel(t),relationships:[],isAutoLoadValue:!0===R.node.getIsAutoLoadValue(t)};m.nodes.push(n),A.notifyListeners(A.Events.NODE_ROOT_ADD,[n]),A.node.loadRelationshipData(n,function(e){n.relationships=e,R.node.getIsAutoExpandRelations(t)?(A.ignoreCount=!0,A.node.expandRelationships(n,function(){A.ignoreCount=!1,A.hasGraphChanged=!0,d()})):(A.hasGraphChanged=!0,d())},Math.PI/2)}},A.loadSchema=function(e){0<m.nodes.length&&p.warn("graph.loadSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:A.node.NodeTypes.ROOT,x:A.getSVGWidth()/2,y:A.getSVGHeight()/2,fx:A.getSVGWidth()/2,fy:A.getSVGHeight()/2,tx:A.getSVGWidth()/2,ty:A.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:A.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===R.node.getIsAutoLoadValue(t.label)};m.nodes.push(n),A.notifyListeners(A.Events.NODE_ROOT_ADD,[n]);var r=R.node.getSchema(e.label);if(void 0!==r&&r.hasOwnProperty("rel")&&0<r.rel.length){var a=Math.PI/2;n.relationships=A.node.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(r.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else A.node.loadRelationshipData(n,function(e){n.relationships=e,A.hasGraphChanged=!0,d()},Math.PI/2);if(t.hasOwnProperty("value")){var o=[].concat(t.value);n.value=[],o.forEach(function(e){n.value.push({id:m.generateId(),parent:n,attributes:e,type:A.node.NodeTypes.VALUE,label:n.label})})}if(t.hasOwnProperty("rel"))for(var l=0;l<t.rel.length;l++)A.loadSchemaRelation(t.rel[l],n,l+1,t.rel.length)},A.loadSchemaRelation=function(e,t,n,r){var a=e.target,o=A.loadSchemaNode(a,t,n,r,e.label,e.hasOwnProperty("isReverse")&&!0===e.isReverse),l={id:"l"+m.generateId(),source:t,target:o,type:A.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l);var i=R.node.getSchema(a.label);if(void 0!==i&&i.hasOwnProperty("rel")&&0<i.rel.length){var s=Math.PI/2;o.relationships=A.node.pie.startAngle(s-Math.PI).endAngle(s+Math.PI)(i.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else A.node.loadRelationshipData(o,function(e){o.relationships=e,A.hasGraphChanged=!0,d()},Math.PI/2);if(a.hasOwnProperty("rel"))for(var u=0;u<a.rel.length;u++)A.loadSchemaRelation(a.rel[u],o,u+1,a.rel.length)},A.loadSchemaNode=function(e,t,n,r,a,o){var l,i=R.node.getIsGroup(e),s=A.computeParentAngle(t);l=s?360/(r+1)*n:360/r*n;var u=t.x+200*Math.cos(l*(Math.PI/180)-s),d=t.y+200*Math.sin(l*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:i?A.node.NodeTypes.GROUP:A.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:A.node.generateInternalLabel(e.label),x:u,y:d,schema:e,isAutoLoadValue:!0===R.node.getIsAutoLoadValue(e.label),relationships:[]};if(!0===o&&(p.isParentRelReverse=!0),e.hasOwnProperty("isNegative")&&!0===e.isNegative&&(p.isNegative=!0,p.count=0),m.nodes.push(p),e.hasOwnProperty("value")){var c=[].concat(e.value);p.value=[],c.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:A.node.NodeTypes.VALUE,label:p.label})})}return p},A.addSchema=function(e){0<m.nodes.length&&p.warn("graph.addSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:A.node.NodeTypes.ROOT,x:A.getSVGWidth()/2,y:A.getSVGHeight()/2,fx:A.getSVGWidth()/2,fy:A.getSVGHeight()/2,tx:A.getSVGWidth()/2,ty:A.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:A.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===R.node.getIsAutoLoadValue(t.label)};if(m.nodes.push(n),A.notifyListeners(A.Events.NODE_ROOT_ADD,[n]),t.hasOwnProperty("rel")&&0<t.rel.length){var r=Math.PI/2;n.relationships=A.node.pie.startAngle(r-Math.PI).endAngle(r+Math.PI)(t.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}},A.addSchemaRelation=function(e,t,n,r){var a=e.target,o=A.addSchemaNode(a,t,n,r,e.label),l={id:"l"+m.generateId(),source:t,target:o,type:A.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l)},A.addSchemaNode=function(e,t,n,r,a){var o,l=R.node.getIsGroup(e),i=e.hasOwnProperty("collapsed")&&!0===e.collapsed,s=A.computeParentAngle(t);o=s?360/(r+1)*n:360/r*n;var u=t.x+200*Math.cos(o*(Math.PI/180)-s),d=t.y+200*Math.sin(o*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:l?A.node.NodeTypes.GROUP:A.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:A.node.generateInternalLabel(e.label),x:u,y:d,schema:e,isAutoLoadValue:!0===R.node.getIsAutoLoadValue(e.label),relationships:[]};if(e.hasOwnProperty("rel")&&0<e.rel.length){for(var c={},g=[],f=0;f<e.rel.length;f++){var h=e.rel[f],v=h.label+h.target.label;c.hasOwnProperty(v)||(c[v]=h,g.push(h))}p.relationships=A.node.pie(g).map(function(e){return{id:e.data.label+e.data.target.label,count:e.data.count||0,label:e.data.label,target:e.data.target.label,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}})}if(e.hasOwnProperty("value")){var E=[].concat(e.value);p.value=[],E.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:A.node.NodeTypes.VALUE,label:p.label})})}if(m.nodes.push(p),!i&&e.hasOwnProperty("rel"))for(var y=0;y<e.rel.length;y++)A.addSchemaRelation(e.rel[y],p,y+1,e.rel.length);return p},A.getSchema=function(){var a={},t=m.getRootNode();a[t.id]={label:t.label},t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}));var e=m.links;return 0<e.length&&e.forEach(function(e){if(e.type===A.link.LinkTypes.RELATION){var t=e.source,n=e.target;a.hasOwnProperty(t.id)||(a[t.id]={label:t.label},t.hasOwnProperty("isNegative")&&!0===t.isNegative&&(a[t.id].isNegative=!0),t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}))),a.hasOwnProperty(n.id)||(a[n.id]={label:n.label},n.hasOwnProperty("isNegative")&&!0===n.isNegative&&(a[n.id].isNegative=!0),n.hasOwnProperty("value")&&(a[n.id].value=[],n.value.forEach(function(e){a[n.id].value.push(e.attributes)}))),a[t.id].hasOwnProperty("rel")||(a[t.id].rel=[]);var r={label:e.label,target:a[n.id]};n.hasOwnProperty("isParentRelReverse")&&!0===n.isParentRelReverse&&(r.isReverse=!0),a[t.id].rel.push(r)}}),a[t.id]},A.tick=function(){var e=A.svg.selectAll("#"+A.link.gID+" > g");if(e.selectAll(".ppt-link").attr("d",function(e){var t=e.source,n=e.target,r=A.computeParentAngle(n),a=R.node.getSize(t),o=R.node.getSize(n);!A.DISABLE_RELATION&&t.hasOwnProperty("relationships")&&0<t.relationships.length&&(a=A.node.getDonutOuterRadius(t)),!A.DISABLE_RELATION&&n.hasOwnProperty("relationships")&&0<n.relationships.length&&(o=A.node.getDonutOuterRadius(n));var l=n.x+o*Math.cos(r),i=n.y-o*Math.sin(r),s=t.x-a*Math.cos(r),u=t.y+a*Math.sin(r),d=(l+s)/2,p=(i+u)/2;return t.x<=n.x||!0===A.ignoreMirroLinkLabels?"M"+s+" "+u+"L"+d+" "+p+"L"+l+" "+i:"M"+l+" "+i+"L"+d+" "+p+"L"+s+" "+u}).attr("marker-end",function(e){if(A.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x>e.target.x)return"url(#arrow)"}else if(e.source.x<=e.target.x)return"url(#arrow)";return null}).attr("marker-start",function(e){if(A.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x<=e.target.x)return"url(#reverse-arrow)"}else if(e.source.x>e.target.x)return"url(#reverse-arrow)";return null}),e.selectAll(".ppt-textPath").attr("xlink:href",function(e){return"#ppt-path_"+e.id}),A.svg.selectAll("#"+A.node.gID+" > g").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),!0===A.USE_VORONOI_LAYOUT){var t=i.select("#voronoi-clip-path").selectAll(".voroclip").data(A.recenterVoronoi(m.nodes),function(e){return e.point.id});t.enter().append("clipPath").attr("id",function(e){return"voroclip-"+e.point.id}).attr("class","voroclip"),t.exit().remove(),t.selectAll("path").remove(),t.append("path").attr("id",function(e){return"pvoroclip-"+e.point.id}).attr("d",function(e){return"M"+e.join(",")+"Z"})}},A.computeParentAngle=function(e){var t=0;if(e.parent){var n=e.parent.x,r=e.parent.y,a=e.x,o=e.y,l=100/(Math.sqrt(Math.pow(n-a,2)+Math.pow(r-o,2))-100),i=((a+l*n)/(1+l)-a)/100;i<-1&&(i=-1),1<i&&(i=1),t=Math.acos(i),o<r&&(t=2*Math.PI-t)}return t},A.addRelationshipData=function(e,t,n,r,a){var o={id:""+m.generateId(),parent:e,parentRel:t.label,type:A.node.NodeTypes.CHOOSE,label:t.target,fixed:!1,internalLabel:A.node.generateInternalLabel(t.target),relationships:[]};!0===t.isReverse&&(o.isParentRelReverse=!0),void 0!==r&&0<r.length&&(o.value=r),void 0!==a&&!0===a&&(o.isNegative=!0);var l={id:"l"+m.generateId(),source:e,target:o,type:A.link.LinkTypes.RELATION,label:t.label};o.x=e.x+2*R.link.getDistance(l)/3*Math.cos(t.directionAngle-Math.PI/2)+10*Math.random(),o.y=e.y+2*R.link.getDistance(l)/3*Math.sin(t.directionAngle-Math.PI/2)+10*Math.random(),o.tx=e.tx+R.link.getDistance(l)*Math.cos(t.directionAngle-Math.PI/2),o.ty=e.ty+R.link.getDistance(l)*Math.sin(t.directionAngle-Math.PI/2),m.nodes.push(o),m.links.push(l),A.hasGraphChanged=!0,d(),A.node.loadRelationshipData(o,function(e){o.relationships=e,A.hasGraphChanged=!0,d(),R.node.getIsAutoExpandRelations(o.label)?A.node.expandRelationships(o,function(){n(o)}):n(o)},t.directionAngle)},A.voronoi=i.voronoi().x(function(e){return e.x}).y(function(e){return e.y}),A.recenterVoronoi=function(e){var r=[];return A.voronoi.polygons(e.map(function(e){return e.x=e.x||0,e.y=e.y||0,e})).forEach(function(t){if(t.length){var n=[];t.forEach(function(e){n.push([e[0]-t.data.x,e[1]-t.data.y])}),n.point=t.data,r.push(n)}}),r};var R={};R.colorScale=i.scaleOrdinal(i.schemeCategory10),R.link={},R.link.Provider={},R.taxonomy={},R.taxonomy.Provider={},R.node={},R.node.Provider={},R.link.getTextValue=function(e){return R.link.Provider.hasOwnProperty("getTextValue")?R.link.Provider.getTextValue(e):R.link.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?R.link.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for link getTextValue")},R.link.getColor=function(e,t,n){return R.link.Provider.hasOwnProperty("getColor")?R.link.Provider.getColor(e,t,n):R.link.DEFAULT_PROVIDER.hasOwnProperty("getColor")?R.link.DEFAULT_PROVIDER.getColor(e,t,n):void p.error("No provider defined for getColor")},R.link.getCSSClass=function(e,t){return R.link.Provider.hasOwnProperty("getCSSClass")?R.link.Provider.getCSSClass(e,t):R.link.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?R.link.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for getCSSClass")},R.link.getDistance=function(e){return R.link.Provider.hasOwnProperty("getDistance")?R.link.Provider.getDistance(e):R.link.DEFAULT_PROVIDER.hasOwnProperty("getDistance")?R.link.DEFAULT_PROVIDER.getDistance(e):void p.error("No provider defined for getDistance")},R.link.getSemanticValue=function(e){return R.link.Provider.hasOwnProperty("getSemanticValue")?R.link.Provider.getSemanticValue(e):R.link.DEFAULT_PROVIDER.hasOwnProperty("getSemanticValue")?R.link.DEFAULT_PROVIDER.getSemanticValue(e):void p.error("No provider defined for getSemanticValue")},R.colorLuminance=function(e,t){(e=String(e).replace(/[^0-9a-f]/gi,"")).length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var n,r,a="#";for(r=0;r<3;r++)n=parseInt(e.substr(2*r,2),16),a+=("00"+(n=Math.round(Math.min(Math.max(0,n+n*t),255)).toString(16))).substr(n.length);return a},R.link.DEFAULT_PROVIDER={getTextValue:function(e){if(e.type===A.link.LinkTypes.VALUE)return R.node.isTextDisplayed(e.target)?"":R.node.getTextValue(e.target);var t="";return e.type===A.link.LinkTypes.SEGMENT&&(t=" "+R.node.getTextValue(e.target)),e.label+t},getDistance:function(e){return e.type===A.link.LinkTypes.VALUE?13/8*(R.node.getSize(e.source)+R.node.getSize(e.target)):2.5*(R.node.getSize(e.source)+R.node.getSize(e.target))},getColor:function(e,t,n){if(e.type===A.link.LinkTypes.VALUE)return"#525863";var r=e.source.label+e.label+e.target.label,a=R.colorScale(r);return"stroke"===n?R.colorLuminance(a,-.2):a},getCSSClass:function(e,t){var n="ppt-link__"+t;if(e.type===A.link.LinkTypes.VALUE)n+="--value";else{var r="ppt-"+e.label.replace(/[^0-9a-z\-_]/gi,"");e.type===A.link.LinkTypes.RELATION&&(n+="--relation",0===e.target.count&&(n+="--disabled"),n=n+" "+r)}return n},getSemanticValue:function(e){return R.link.getTextValue(e)}},R.link.Provider=R.link.DEFAULT_PROVIDER,R.taxonomy.getTextValue=function(e){return R.taxonomy.Provider.hasOwnProperty("getTextValue")?R.taxonomy.Provider.getTextValue(e):R.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?R.taxonomy.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for taxonomy getTextValue")},R.taxonomy.getCSSClass=function(e,t){return R.taxonomy.Provider.hasOwnProperty("getCSSClass")?R.taxonomy.Provider.getCSSClass(e,t):R.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?R.taxonomy.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for taxonomy getCSSClass")},R.taxonomy.DEFAULT_PROVIDER={getTextValue:function(e){return e},getCSSClass:function(e,t){return"ppt-taxo__"+t+" "+e.replace(/[^0-9a-z\-_]/gi,"")}},R.taxonomy.Provider=R.taxonomy.DEFAULT_PROVIDER,R.node.DisplayTypes=Object.freeze({TEXT:0,IMAGE:1,SVG:2,SYMBOL:3}),R.node.getProvider=function(e){if(void 0!==e){if(R.node.Provider.hasOwnProperty(e))return R.node.Provider[e];for(var t in p.debug("No direct provider found for label "+e),R.node.Provider)if(R.node.Provider.hasOwnProperty(t)){var n=R.node.Provider[t];if(n.hasOwnProperty("children")&&-1<n.children.indexOf(e)){p.debug("No provider is defined for label ("+e+"), parent ("+t+") will be used");var r={parent:t};for(var a in n)n.hasOwnProperty(a)&&"children"!==a&&"parent"!==a&&(r[a]=n[a]);return R.node.Provider[e]=r,R.node.Provider[e]}}for(var o in p.debug("No label provider defined for label ("+e+") default one will be created from provider.node.DEFAULT_PROVIDER"),R.node.Provider[e]={},R.node.DEFAULT_PROVIDER)R.node.DEFAULT_PROVIDER.hasOwnProperty(o)&&(R.node.Provider[e][o]=R.node.DEFAULT_PROVIDER[o]);return R.node.Provider[e]}p.error("Node label is undefined, no label provider can be found.")},R.node.getProperty=function(e,t){var n=R.node.getProvider(e);if(!n.hasOwnProperty(t)){for(var r=n,a=!1;r.hasOwnProperty("parent")&&!a;)(r=R.node.getProvider(r.parent)).hasOwnProperty(t)&&(n[t]=r[t],a=!0);a||(p.debug('No "'+t+'" property found for node label provider ('+e+"), default value will be used"),R.node.DEFAULT_PROVIDER.hasOwnProperty(t)?n[t]=R.node.DEFAULT_PROVIDER[t]:p.debug('No default value for "'+t+'" property found for label provider ('+e+")"))}return n[t]},R.node.getIsAutoLoadValue=function(e){return R.node.getProperty(e,"isAutoLoadValue")},R.node.getIsSearchable=function(e){return R.node.getProperty(e,"isSearchable")},R.node.getIsAutoExpandRelations=function(e){return R.node.getProperty(e,"autoExpandRelations")},R.node.getSchema=function(e){return R.node.getProperty(e,"schema")},R.node.getReturnAttributes=function(e){var t=R.node.getProvider(e),n={};if(t.hasOwnProperty("returnAttributes"))for(var r=0;r<t.returnAttributes.length;r++)t.returnAttributes[r]===v.NEO4J_INTERNAL_ID?n[v.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[r]]=!0;for(;t.hasOwnProperty("parent");)if((t=R.node.getProvider(t.parent)).hasOwnProperty("returnAttributes"))for(var a=0;a<t.returnAttributes.length;a++)t.returnAttributes[a]===v.NEO4J_INTERNAL_ID?n[v.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[a]]=!0;if(R.node.DEFAULT_PROVIDER.hasOwnProperty("returnAttributes"))for(var o=0;o<R.node.DEFAULT_PROVIDER.returnAttributes.length;o++)R.node.DEFAULT_PROVIDER.returnAttributes[o]!==v.NEO4J_INTERNAL_ID&&(n[R.node.DEFAULT_PROVIDER.returnAttributes[o]]=!0);var l=R.node.getConstraintAttribute(e);l===v.NEO4J_INTERNAL_ID?n[v.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[l]=!0;var i=[];for(var s in n)n.hasOwnProperty(s)&&(s===v.NEO4J_INTERNAL_ID.queryInternalName?i.push(v.NEO4J_INTERNAL_ID):i.push(s));return i.length<=0&&i.push(v.NEO4J_INTERNAL_ID),i},R.node.getConstraintAttribute=function(e){return R.node.getProperty(e,"constraintAttribute")},R.node.getDisplayAttribute=function(e){var t=R.node.getProperty(e,"displayAttribute");if(void 0===t){var n=R.node.getReturnAttributes(e);t=0<n.length?n[0]:R.node.getConstraintAttribute(e)}return t},R.node.getPredefinedConstraints=function(e){return R.node.getProperty(e,"getPredefinedConstraints")()},R.node.filterResultQuery=function(e,t){return R.node.getProperty(e,"filterResultQuery")(t)},R.node.getValueOrderByAttribute=function(e){return R.node.getProperty(e,"valueOrderByAttribute")},R.node.isValueOrderAscending=function(e){return R.node.getProperty(e,"isValueOrderAscending")},R.node.getResultOrderByAttribute=function(e){return R.node.getProperty(e,"resultOrderByAttribute")},R.node.isResultOrderAscending=function(e){return R.node.getProperty(e,"isResultOrderAscending")},R.node.getTextValue=function(e,t){return R.node.getProperty(e.label,"getTextValue")(e,t)},R.node.getSemanticValue=function(e){return R.node.getProperty(e.label,"getSemanticValue")(e)},R.node.getSVGPaths=function(e){return R.node.getProperty(e.label,"getSVGPaths")(e)},R.node.isTextDisplayed=function(e){return R.node.getProperty(e.label,"getIsTextDisplayed")(e)},R.node.getSize=function(e){return R.node.getProperty(e.label,"getSize")(e)},R.node.getColor=function(e,t){return R.node.getProperty(e.label,"getColor")(e,t)},R.node.getCSSClass=function(e,t){return R.node.getProperty(e.label,"getCSSClass")(e,t)},R.node.getIsGroup=function(e){return R.node.getProperty(e.label,"getIsGroup")(e)},R.node.getNodeDisplayType=function(e){return R.node.getProperty(e.label,"getDisplayType")(e)},R.node.getImagePath=function(e){return R.node.getProperty(e.label,"getImagePath")(e)},R.node.getImageWidth=function(e){return R.node.getProperty(e.label,"getImageWidth")(e)},R.node.getImageHeight=function(e){return R.node.getProperty(e.label,"getImageHeight")(e)},R.node.filterNodeValueQuery=function(e,t){return R.node.getProperty(e.label,"filterNodeValueQuery")(e,t)},R.node.filterNodeCountQuery=function(e,t){return R.node.getProperty(e.label,"filterNodeCountQuery")(e,t)},R.node.filterNodeRelationQuery=function(e,t){return R.node.getProperty(e.label,"filterNodeRelationQuery")(e,t)},R.node.getDisplayResults=function(e){return R.node.getProperty(e,"displayResults")},R.node.DEFAULT_PROVIDER={isSearchable:!0,autoExpandRelations:!1,isAutoLoadValue:!1,returnAttributes:[v.NEO4J_INTERNAL_ID],valueOrderByAttribute:"count",isValueOrderAscending:!1,resultOrderByAttribute:null,isResultOrderAscending:!0,constraintAttribute:v.NEO4J_INTERNAL_ID,displayAttribute:void 0,getPredefinedConstraints:function(){return[]},filterResultQuery:function(e){return e},getDisplayType:function(e){return R.node.DisplayTypes.TEXT},getSize:function(e){return 50},getColor:function(e){if(e.type===A.node.NodeTypes.VALUE)return R.node.getColor(e.parent);var t="";e.hasOwnProperty("parent")&&(t=e.parent.label);var n=t+(e.parentRel||"")+e.label;return R.colorScale(n)},getCSSClass:function(e,t){var n=e.label.replace(/[^0-9a-z\-_]/gi,""),r="ppt-node__"+t;return e.type===A.node.NodeTypes.ROOT&&(r+="--root"),e.type===A.node.NodeTypes.CHOOSE&&(r+="--choose"),e.type===A.node.NodeTypes.GROUP&&(r+="--group"),e.type===A.node.NodeTypes.VALUE&&(r+="--value"),void 0!==e.value&&0<e.value.length&&(r+="--value-selected"),0===e.count&&(r+="--disabled"),r+" "+n},getIsGroup:function(e){return!1},getIsTextDisplayed:function(e){return!0},getTextValue:function(e,t){var n="",r=R.node.getDisplayAttribute(e.label);if(e.type===A.node.NodeTypes.VALUE)n=r===v.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[r];else if(void 0!==e.value&&0<e.value.length)if(r===v.NEO4J_INTERNAL_ID){var a="";e.value.forEach(function(e){n+=a+e.internalID,a=" or "})}else{a="";e.value.forEach(function(e){n+=a+e.attributes[r],a=" or "})}else n=e.label;return n},getSemanticValue:function(e){var t="",n=R.node.getDisplayAttribute(e.label);if(e.type===A.node.NodeTypes.VALUE)t=n===v.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[n];else if(void 0!==e.value&&0<e.value.length)if(n===v.NEO4J_INTERNAL_ID){var r="";e.value.forEach(function(e){t+=r+e.internalID,r=" or "})}else{r="";e.value.forEach(function(e){t+=r+e.attributes[n],r=" or "})}else t=e.label;return t},getImagePath:function(e){return"image/node/"+e.label.toLowerCase()+"/"+e.label.toLowerCase()+".svg"},getSVGPaths:function(e){var t=R.node.getSize(e);return[{d:"M 0, 0 m -"+t+", 0 a "+t+","+t+" 0 1,0 "+2*t+",0 a "+t+","+t+" 0 1,0 -"+2*t+",0",fill:"transparent",stroke:R.node.getColor(e),"stroke-width":"2px"}]},getImageWidth:function(e){return 2*R.node.getSize(e)},getImageHeight:function(e){return 2*R.node.getSize(e)},filterNodeValueQuery:function(e,t){return t},filterNodeCountQuery:function(e,t){return t},filterNodeRelationQuery:function(e,t){return t},displayResults:function(r){var a=r.data()[0];R.node.getReturnAttributes(a.label).forEach(function(e){var t=r.append("div").attr("class","ppt-result-attribute-div"),n=e;v.NEO4J_INTERNAL_ID===e&&(n=v.NEO4J_INTERNAL_ID.queryInternalName),t.append("span").text(function(){return e===v.NEO4J_INTERNAL_ID?"internal ID:":e+":"}),void 0!==a.attributes[n]&&t.append("span").text(function(e){return e.attributes[n]})})}};var N={containerId:"popoto-query",QUERY_STARTER:"I'm looking for",CHOOSE_LABEL:"choose",createQueryArea:function(){var e="#"+N.containerId;N.queryConstraintSpanElements=i.select(e).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan"),N.querySpanElements=i.select(e).append("p").attr("class","ppt-query-elements").selectAll(".querySpan")},updateQuery:function(){N.queryConstraintSpanElements=N.queryConstraintSpanElements.data([]),N.querySpanElements=N.querySpanElements.data([]),N.queryConstraintSpanElements.exit().remove(),N.querySpanElements.exit().remove(),N.queryConstraintSpanElements=N.queryConstraintSpanElements.data(N.generateConstraintData(m.links,m.nodes)),N.querySpanElements=N.querySpanElements.data(N.generateData(m.links,m.nodes)),N.queryConstraintSpanElements=N.queryConstraintSpanElements.enter().append("span").on("contextmenu",N.rightClickSpan).on("click",N.clickSpan).on("mouseover",N.mouseOverSpan).on("mouseout",N.mouseOutSpan).merge(N.queryConstraintSpanElements),N.querySpanElements=N.querySpanElements.enter().append("span").on("contextmenu",N.rightClickSpan).on("click",N.clickSpan).on("mouseover",N.mouseOverSpan).on("mouseout",N.mouseOutSpan).merge(N.querySpanElements),N.queryConstraintSpanElements.attr("id",function(e){return e.id}).attr("class",function(e){return e.isLink?"ppt-span-link":e.type===A.node.NodeTypes.ROOT?"ppt-span-root":e.type===A.node.NodeTypes.CHOOSE?void 0!==e.ref.value&&0<e.ref.value.length?"ppt-span-value":"ppt-span-choose":e.type===A.node.NodeTypes.VALUE?"ppt-span-value":e.type===A.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(e){return e.term+" "}),N.querySpanElements.attr("id",function(e){return e.id}).attr("class",function(e){return e.isLink?"ppt-span-link":e.type===A.node.NodeTypes.ROOT?"ppt-span-root":e.type===A.node.NodeTypes.CHOOSE?void 0!==e.ref.value&&0<e.ref.value.length?"ppt-span-value":"ppt-span-choose":e.type===A.node.NodeTypes.VALUE?"ppt-span-value":e.type===A.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(e){return e.term+" "})},generateConstraintData:function(e,t){var r=[],a=0;return r.push({id:a++,term:N.QUERY_STARTER}),0<t.length&&r.push({id:a++,type:t[0].type,term:R.node.getSemanticValue(t[0]),ref:t[0]}),e.forEach(function(e){var t=e.source,n=e.target;e.type===A.link.LinkTypes.RELATION&&n.type!==A.node.NodeTypes.GROUP&&void 0!==n.value&&0<n.value.length&&(t.type===A.node.NodeTypes.GROUP&&r.push({id:a++,type:t.type,term:R.node.getSemanticValue(t),ref:t}),r.push({id:a++,isLink:!0,term:R.link.getSemanticValue(e),ref:e}),n.type!==A.node.NodeTypes.GROUP&&(void 0!==n.value&&0<n.value.length?r.push({id:a++,type:n.type,term:R.node.getSemanticValue(n),ref:n}):r.push({id:a++,type:n.type,term:"<"+N.CHOOSE_LABEL+" "+R.node.getSemanticValue(n)+">",ref:n})))}),r},generateData:function(e,t){var r=[],a=[],o=0;return e.forEach(function(e){var t=e.source,n=e.target;n.type===A.node.NodeTypes.GROUP&&a.push({id:o++,type:n.type,term:R.node.getSemanticValue(n),ref:n}),e.type!==A.link.LinkTypes.RELATION||n.type===A.node.NodeTypes.GROUP||void 0!==n.value&&0!==n.value.length||(t.type===A.node.NodeTypes.GROUP&&r.push({id:o++,type:t.type,term:R.node.getSemanticValue(t),ref:t}),r.push({id:o++,isLink:!0,term:R.link.getSemanticValue(e),ref:e}),n.type!==A.node.NodeTypes.GROUP&&r.push({id:o++,type:n.type,term:"<"+N.CHOOSE_LABEL+" "+R.node.getSemanticValue(n)+">",ref:n}))}),r.concat(a)},mouseOverSpan:function(){i.select(this).classed("hover",function(e){return e.ref});var t=i.select(this).data()[0];if(t.ref){var e=A.svg.selectAll("#"+A.link.gID+" > g").filter(function(e){return e===t.ref});e.select("path").classed("ppt-link-hover",!0),e.select("text").classed("ppt-link-hover",!0),A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),T.isActive&&T.querySpanElements.filter(function(e){return e.node===t.ref||e.link===t.ref}).classed("hover",!0)}},rightClickSpan:function(){var t=i.select(this).data()[0];if(!t.isLink&&t.ref){var e=A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.ref});e.on("contextmenu").call(e.node(),t.ref)}},clickSpan:function(){var t=i.select(this).data()[0];if(!t.isLink&&t.ref){var e=A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.ref});e.on("click").call(e.node(),t.ref)}},mouseOutSpan:function(){i.select(this).classed("hover",!1);var t=i.select(this).data()[0];if(t.ref){var e=A.svg.selectAll("#"+A.link.gID+" > g").filter(function(e){return e===t.ref});e.select("path").classed("ppt-link-hover",!1),e.select("text").classed("ppt-link-hover",!1),A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),T.isActive&&T.querySpanElements.filter(function(e){return e.node===t.ref||e.link===t.ref}).classed("hover",!1)}}},T={containerId:"popoto-cypher",MATCH:"MATCH",RETURN:"RETURN",WHERE:"WHERE"};T.QueryElementTypes=Object.freeze({KEYWORD:0,NODE:1,SEPARATOR:2,SOURCE:3,LINK:4,TARGET:5,RETURN:6,WHERE:7}),T.createQueryArea=function(){var e="#"+T.containerId;T.querySpanElements=i.select(e).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan")},T.updateQuery=function(){T.querySpanElements=T.querySpanElements.data([]),T.querySpanElements.exit().remove(),T.querySpanElements=T.querySpanElements.data(T.generateData(m.links,m.nodes)),T.querySpanElements=T.querySpanElements.enter().append("span").attr("id",function(e){return"cypher-"+e.id}).on("mouseover",T.mouseOverSpan).on("mouseout",T.mouseOutSpan).on("contextmenu",T.rightClickSpan).on("click",T.clickSpan).merge(T.querySpanElements),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.KEYWORD}).attr("class","ppt-span").text(function(e){return" "+e.value+" "}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.SEPARATOR}).attr("class","ppt-span").text(function(e){return e.value+" "}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.NODE}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(e){return"("+e.node.internalLabel+":`"+e.node.label+"`)"}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.SOURCE}).attr("class",function(e){return e.node===m.getRootNode()?void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root":void 0!==e.node.value&&0<e.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(e){var t=e.node;return"("+t.internalLabel+":`"+t.label+"`)"}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.LINK}).attr("class","ppt-span-link").text(function(e){return!0===e.link.target.isParentRelReverse?"<-[:`"+e.link.label+"`]-":"-[:`"+e.link.label+"`]-"+(v.USE_RELATION_DIRECTION?">":"")}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.TARGET}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(e){return"("+e.node.internalLabel+":`"+e.node.label+"`)"}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.WHERE}).attr("class",function(e){return e.node===m.getRootNode()?"ppt-span-root-value":"ppt-span-value"}).text(function(t){var e=t.node;if(!0===e.isNegative){if(!e.hasOwnProperty("value")||e.value.length<=0)return"(NOT ("+t.link.source.internalLabel+":`"+t.link.source.label+"`)-[:`"+t.link.label+"`]->(:`"+t.link.target.label+"`))";var n=[],r=R.node.getConstraintAttribute(e.label);return e.value.forEach(function(e){n.push("(NOT ("+t.link.source.internalLabel+":`"+t.link.source.label+"`)-[:`"+t.link.label+"`]->(:`"+t.link.target.label+"`{"+r+":"+e.attributes[r]+"}))")}),n.join(" AND ")}var a=R.node.getConstraintAttribute(e.label),o="",l="";return a===v.NEO4J_INTERNAL_ID?o+=e.internalLabel+".id":o+=e.internalLabel+"."+a,e.hasOwnProperty("value")&&1<e.value.length?o+=" IN [":o+=" = ",e.value.forEach(function(e){if(o+=l,l=", ",a===v.NEO4J_INTERNAL_ID)o+=e.internalID;else{var t=e.attributes[a];o+="boolean"==typeof t||"number"==typeof t?t:'"'+t+'"'}}),1<e.value.length&&(o+="]"),"("+o+")"}),T.querySpanElements.filter(function(e){return e.type===T.QueryElementTypes.RETURN}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(e){return e.node.internalLabel})},T.generateData=function(e){var t=[],n=0,r=m.getRootNode(),a=v.getRelevantLinks(r,r,e),o=a.filter(function(e){return!0===e.target.isNegative&&(!e.target.hasOwnProperty("value")||e.target.value.length<=0)});t.push({id:n++,type:T.QueryElementTypes.KEYWORD,value:T.MATCH}),r&&t.push({id:n++,type:T.QueryElementTypes.NODE,node:r}),0<a.length&&a.length>o.length&&t.push({id:n++,type:T.QueryElementTypes.SEPARATOR,value:","});for(var l=0;l<a.length;l++){!0===(s=a[l]).target.isNegative&&(!s.target.hasOwnProperty("value")||s.target.value.length<=0)||(t.push({id:n++,type:T.QueryElementTypes.SOURCE,node:s.source}),t.push({id:n++,type:T.QueryElementTypes.LINK,link:s}),t.push({id:n++,type:T.QueryElementTypes.TARGET,node:s.target}),l<a.length-1&&t.push({id:n++,type:T.QueryElementTypes.SEPARATOR,value:","}))}(r&&void 0!==r.value&&0<r.value.length||0<a.length)&&t.push({id:n++,type:T.QueryElementTypes.KEYWORD,value:T.WHERE}),r&&void 0!==r.value&&0<r.value.length&&(t.push({id:n++,type:T.QueryElementTypes.WHERE,node:r}),0<a.length&&t.push({id:n++,type:T.QueryElementTypes.SEPARATOR,value:" AND "}));var i=!1;for(l=0;l<a.length;l++){var s;!0===(s=a[l]).target.isNegative?(i&&t.push({id:n++,type:T.QueryElementTypes.SEPARATOR,value:" AND "}),t.push({id:n++,type:T.QueryElementTypes.WHERE,node:s.target,link:s}),i=!0):void 0!==s.target.value&&0<s.target.value.length&&(i&&t.push({id:n++,type:T.QueryElementTypes.SEPARATOR,value:" AND "}),t.push({id:n++,type:T.QueryElementTypes.WHERE,node:s.target}),i=!0)}return t.push({id:n++,type:T.QueryElementTypes.KEYWORD,value:T.RETURN}),r&&t.push({id:n++,type:T.QueryElementTypes.RETURN,node:r}),t},T.mouseOverSpan=function(){var t=i.select(this).data()[0];if(t.node)T.querySpanElements.filter(function(e){return e.node===t.node}).classed("hover",!0),A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!0),N.querySpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!0));else if(t.link){i.select(this).classed("hover",!0);var e=A.svg.selectAll("#"+A.link.gID+" > g").filter(function(e){return e===t.link});e.select("path").classed("ppt-link-hover",!0),e.select("text").classed("ppt-link-hover",!0)}},T.mouseOutSpan=function(){var t=i.select(this).data()[0];if(t.node)T.querySpanElements.filter(function(e){return e.node===t.node}).classed("hover",!1),A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),N.isActive&&(N.queryConstraintSpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!1),N.querySpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!1));else if(t.link){i.select(this).classed("hover",!1);var e=A.svg.selectAll("#"+A.link.gID+" > g").filter(function(e){return e===t.link});e.select("path").classed("ppt-link-hover",!1),e.select("text").classed("ppt-link-hover",!1)}},T.clickSpan=function(){var t=i.select(this).data()[0];if(t.node){var e=A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.node});e.on("click").call(e.node(),t.node)}},T.rightClickSpan=function(){var t=i.select(this).data()[0];if(t.node){var e=A.svg.selectAll("#"+A.node.gID+" > g").filter(function(e){return e===t.node});e.on("contextmenu").call(e.node(),t.node)}},e.version=t,e.cypherviewer=T,e.graph=A,e.logger=p,e.provider=R,e.query=v,e.queryviewer=N,e.rest=c,e.result=g,e.taxonomy=s,e.tools=n,e.dataModel=m,e.start=function(e){if(p.info("Popoto 2.0.3 start on "+e),A.mainLabel=e,void 0===c.CYPHER_URL)p.error("popoto.rest.CYPHER_URL is not set but is required.");else{if(n=i.select("#"+A.containerId),r=i.select("#"+s.containerId),a=i.select("#"+N.containerId),o=i.select("#"+T.containerId),l=i.select("#"+g.containerId),n.empty()?(p.debug("The page doesn't contain a container with ID = \""+A.containerId+'" no graph area will be generated. This ID is defined in graph.containerId property.'),A.isActive=!1):A.isActive=!0,r.empty()?(p.debug("The page doesn't contain a container with ID = \""+s.containerId+'" no taxonomy filter will be generated. This ID is defined in taxonomy.containerId property.'),s.isActive=!1):s.isActive=!0,a.empty()?(p.debug("The page doesn't contain a container with ID = \""+N.containerId+'" no query viewer will be generated. This ID is defined in queryviewer.containerId property.'),N.isActive=!1):N.isActive=!0,o.empty()?(p.debug("The page doesn't contain a container with ID = \""+T.containerId+'" no cypher query viewer will be generated. This ID is defined in cypherviewer.containerId property.'),T.isActive=!1):T.isActive=!0,l.empty()?(p.debug("The page doesn't contain a container with ID = \""+g.containerId+'" no result area will be generated. This ID is defined in result.containerId property.'),g.isActive=!1):g.isActive=!0,s.isActive&&s.createTaxonomyPanel(),A.isActive)if(A.createGraphArea(),A.createForceLayout(),"string"==typeof e||e instanceof String){var t=R.node.getSchema(e);void 0!==t?A.addSchema(t):A.addRootNode(e)}else A.loadSchema(e);N.isActive&&N.createQueryArea(),T.isActive&&T.createQueryArea(),!0===A.USE_VORONOI_LAYOUT&&A.voronoi.extent([[-popoto.graph.getSVGWidth(),-popoto.graph.getSVGWidth()],[2*popoto.graph.getSVGWidth(),2*popoto.graph.getSVGHeight()]]),f()}var n,r,a,o,l},e.update=f,e.updateGraph=d,Object.defineProperty(e,"__esModule",{value:!0})});